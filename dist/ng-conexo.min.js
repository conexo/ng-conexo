!function(e){e.module("ngConexo.config",[]).value("ngConexo.config",{debug:!0}),e.module("ngConexo.services",[]),e.module("ngConexo",["ngConexo.config","ngConexo.services","ngCookies","ngSanitize"])}(angular);var mod=angular.module("ngConexo.services");mod.constant("$cxConstants",{LOGOUT:4,LOGIN:5,OPEN_UC:11}),mod.constant("USER_ROLES",{all:"*",unknown:"unknown",notConfirmed:"not-confirmed",fullUser:"full-user"}),mod.factory("$cxAuth",["$cxRequest","$q","$cookies","$cookieStore","$cxConstants",function(e,t,n,o){var i,r={};return r.updateSession=function(e){o.put("context",e)},r.getAuth=function(){var t=e.getSessionContext();return void 0===t&&(t=n.context,void 0!==t&&e.setSessionContext(angular.fromJson(t))),t},r.cleanAuth=function(){i={role:"unknown"},o.remove("context"),o.remove("user")},r.isAuthenticated=function(){return void 0!==this.getAuth()},r.isAuthorized=function(e){return angular.isArray(e)||(e=[e]),console.log("user role: "+i.role+" authorized: "+e[0]),-1!==e.indexOf(i.role)},r.login=function(n){var i=t.defer();return e.openSession(n).then(function(e){console.log(e),o.put("context",e),i.resolve(e.mainUCid)},function(e){i.reject(e)}),i.promise},r.logout=function(){var n=t.defer();return e.closeSession().then(function(){r.cleanAuth(),n.resolve(!0)},function(e){n.reject(e)}),n.promise},e.registerContextListener(r.updateSession),r.getAuth(),r}]);var mod=angular.module("ngConexo.services");mod.provider("$cxRequest",[function(){var e="",t="localhost",n="",o="",i="",r=1e4,s={},c=function(){s={headers:{"Content-type":"application/json",cxSystemCode:n,cxServer:t,cxPort:o}}};this.setUrl=function(t){e=t},this.setServer=function(e){t=e,c()},this.setSysCode=function(e){n=e,c()},this.setPort=function(e){o=e,c()},this.setChannel=function(e){i=e},this.setTimeout=function(e){r=e},this.$get=function(t,o,c,u,S){var a,d={};return d.registerContextListener=function(e){this.contextListener=e},d.getSessionContext=function(){return this.context},d.setSessionContext=function(e){this.context=e},d.initSessionContext=function(){var e={mainUCid:void 0,openUC:{}};return e},d.resetSessionContext=function(){this.context=void 0},d.updateContext=function(){void 0!==this.contextListener&&this.contextListener(this.getSessionContext())},d.getSessionContext=function(){return this.context},d.newRequest=function(e,t){var n={};return n.ucid=e,n.signal=t,n.data={SYSMSG:{_SignalName:void 0,_SerialNumber:void 0,_Recipient:void 0,_Sender:void 0}},n.send=function(){return d.callUseCase(this.ucid,this.signal,this.data)},n},d.execute=function(n){var i=this,c=o.defer();return t.post(e,n,s).success(function(e){1===e.SYSMSG._Id?c.reject(e.SYSMSG.MESSAGE[0]._):2===e.SYSMSG._Id?c.reject(e.SYSMSG.MESSAGE[0]._):(void 0!==i.timer&&S.cancel(a),console.log("reset timeout"),i.timer=S(function(){console.log("timeout reached"),i.resetSessionContext()},r),c.resolve(e))}).error(function(e){c.reject(e)}),c.promise},d.openSession=function(e){var t=this,r=o.defer(),s={SYSMSG:{_SignalName:u.LOGIN,_Recipient:0,SYSTEM_CODE:n,LOGIN:e.username,PASSWORD:e.password,AUDIT_CONTEXT:"",CLIENT_VERSION:"1.0.5.0",CHANNEL:i}};return console.log(s),t.execute(s).then(function(e){t.context=t.initSessionContext(),t.context.mainUCid=e.SYSMSG.UCID[0]._,r.resolve(t.context)},function(e){r.reject(e)}),r.promise},d.closeSession=function(){var e=this,t=o.defer(),n={SYSMSG:{_SignalName:u.LOGOUT}};return e.execute(n).then(function(){e.resetSessionContext(),t.resolve(!0)},function(e){t.reject(e)}),t.promise},d.openUseCase=function(e){var t={SYSMSG:{_Recipient:this.context.mainUCid,_SignalName:u.OPEN_UC,USECASEID:e,GUIID:e}};return this.execute(t)},d.callUseCase=function(e,t,n){var i=this,r=o.defer();return console.log(i.context),void 0!==i.context?(console.log(i.context.openUC),void 0===i.context.openUC[e]?i.openUseCase(e).then(function(o){console.log("uc opened"),console.log(o),i.context.openUC[e]=o.SYSMSG.UCID[0]._,i.updateContext(),n.SYSMSG._SignalName=t,n.SYSMSG._Recipient=i.context.openUC[e],i.execute(n).then(function(e){r.resolve(e)},function(e){r.reject(e)})},function(e){r.reject(e)}):(n.SYSMSG._SignalName=t,n.SYSMSG._Recipient=i.context.openUC[e],i.execute(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}))):r.reject("not authenticated"),r.promise},d}}]);var mod=angular.module("ngConexo.services");mod.factory("$cxRequestInterceptor",["$injector",function(e){var t={};return t.request=function(t){var n=e.get("$cxAuth").getAuth();return"POST"===t.method&&void 0!==t.data&&(void 0===t.data.SYSMSG._SerialNumber&&(t.data.SYSMSG._SerialNumber=0),void 0===t.data.SYSMSG._Sender&&(t.data.SYSMSG._Sender=0),void 0===t.data.SYSMSG._Recipient&&(t.data.SYSMSG._Recipient=void 0!==n?n.mainUCid:0)),t},t}]),mod.config(["$httpProvider",function(e){e.interceptors.push("$cxRequestInterceptor")}]);