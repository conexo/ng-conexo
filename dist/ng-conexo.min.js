!function(e){e.module("ngConexo.config",[]).value("ngConexo.config",{debug:!0}),e.module("ngConexo.services",[]),e.module("ngConexo",["ngConexo.config","ngConexo.services","ngCookies","ngSanitize"])}(angular);var mod=angular.module("ngConexo.services");mod.constant("$cxConstants",{LOGOUT:4,LOGIN:5,OPEN_UC:11}),mod.factory("$cxAuth",["$cxRequest","$q","$cookies","$cookieStore","$cxConstants",function(e,t,n,o){var i={};return i.updateSession=function(e){o.put("context",e)},i.getAuth=function(){var t=e.getSessionContext();return void 0===t&&(t=n.context,void 0!==t&&e.setSessionContext(angular.fromJson(t))),t},i.cleanAuth=function(){o.remove("context"),o.remove("user"),this.user={name:"",nature:"anonymous"}},i.isAuthenticated=function(){return void 0!==this.getAuth()},i.isAuthorized=function(e){return angular.isArray(e)||(e=[e]),console.log("user role: "+this.user.nature+" authorized: "+e[0]),-1!==e.indexOf(this.user.nature)},i.login=function(n){var i=this,s=t.defer();return e.openSession(n).then(function(t){console.log(t),o.put("context",t);var n=e.newRequest(2759,"RM_OBTEM_DADOS_USUARIO");n.send().then(function(e){i.user={},i.user.id=e.SYSMSG.user[0].id[0]._,i.user.login=e.SYSMSG.user[0].login[0]._,i.user.nature=e.SYSMSG.user[0].nature[0]._,void 0!==e.SYSMSG.user[0].name&&(i.user.name=e.SYSMSG.user[0].name[0]._),o.put("user",i.user),s.resolve(i.user)},function(e){s.reject(e)})},function(e){s.reject(e)}),s.promise},i.logout=function(){var n=t.defer();return e.closeSession().then(function(){i.cleanAuth(),n.resolve(!0)},function(e){n.reject(e)}),n.promise},i.getUser=function(){return void 0===this.user&&(this.user=n.user,this.user=void 0===this.user?{name:"",nature:"anonymous"}:angular.fromJson(this.user)),this.user},e.registerContextListener(i.updateSession),i.getAuth(),i.getUser(),i}]);var mod=angular.module("ngConexo.services");mod.provider("$cxRequest",[function(){var e="",t="localhost",n="",o="",i="",s=1e4,r={},u=function(){r={headers:{"Content-type":"application/json",cxSystemCode:n,cxServer:t,cxPort:o}}};this.setUrl=function(t){e=t},this.setServer=function(e){t=e,u()},this.setSysCode=function(e){n=e,u()},this.setPort=function(e){o=e,u()},this.setChannel=function(e){i=e},this.setTimeout=function(e){s=e},this.$get=function(t,o,u,c,S){var a,d={};return d.registerContextListener=function(e){this.contextListener=e},d.getSessionContext=function(){return this.context},d.setSessionContext=function(e){this.context=e},d.initSessionContext=function(){var e={mainUCid:void 0,openUC:{}};return e},d.resetSessionContext=function(){this.context=void 0},d.updateContext=function(){void 0!==this.contextListener&&this.contextListener(this.getSessionContext())},d.getSessionContext=function(){return this.context},d.newRequest=function(e,t){var n={};return n.ucid=e,n.signal=t,n.data={SYSMSG:{_SignalName:void 0,_SerialNumber:void 0,_Recipient:void 0,_Sender:void 0}},n.send=function(){return d.callUseCase(this.ucid,this.signal,this.data)},n},d.execute=function(n){var i=this,u=o.defer();return console.log("execute:"),console.log(n),t.post(e,n,r).success(function(e){console.log(e),1===e.SYSMSG._Id?u.reject(e.SYSMSG.MESSAGE[0]._):2===e.SYSMSG._Id?u.reject(e.SYSMSG.MESSAGE[0]._):(void 0!==i.timer&&S.cancel(a),console.log("reset timeout"),i.timer=S(function(){console.log("timeout reached"),i.resetSessionContext()},s),u.resolve(e))}).error(function(e){u.reject(e)}),u.promise},d.openSession=function(e){var t=this,s=o.defer(),r={SYSMSG:{_SignalName:c.LOGIN,_Recipient:0,SYSTEM_CODE:n,LOGIN:e.username,PASSWORD:e.password,AUDIT_CONTEXT:"",CLIENT_VERSION:"1.0.5.0",CHANNEL:i}};return console.log(r),t.execute(r).then(function(e){t.context=t.initSessionContext(),t.context.mainUCid=e.SYSMSG.UCID[0]._,s.resolve(t.context)},function(e){s.reject(e)}),s.promise},d.closeSession=function(){var e=this,t=o.defer(),n={SYSMSG:{_SignalName:c.LOGOUT}};return e.execute(n).then(function(){e.resetSessionContext(),t.resolve(!0)},function(e){t.reject(e)}),t.promise},d.openUseCase=function(e){var t={SYSMSG:{_Recipient:this.context.mainUCid,_SignalName:c.OPEN_UC,USECASEID:e,GUIID:e}};return this.execute(t)},d.callUseCase=function(e,t,n){var i=this,s=o.defer();return console.log(i.context),void 0!==i.context?(console.log(i.context.openUC),void 0===i.context.openUC[e]?i.openUseCase(e).then(function(o){console.log("uc opened"),console.log(o),i.context.openUC[e]=o.SYSMSG.UCID[0]._,i.updateContext(),n.SYSMSG._SignalName=t,n.SYSMSG._Recipient=i.context.openUC[e],i.execute(n).then(function(e){s.resolve(e)},function(e){s.reject(e)})},function(e){s.reject(e)}):(n.SYSMSG._SignalName=t,n.SYSMSG._Recipient=i.context.openUC[e],i.execute(n).then(function(e){s.resolve(e)},function(e){s.reject(e)}))):s.reject("not authenticated"),s.promise},d}}]);var mod=angular.module("ngConexo.services");mod.factory("$cxRequestInterceptor",["$injector",function(e){var t={};return t.request=function(t){var n=e.get("$cxAuth").getAuth();return"POST"===t.method&&void 0!==t.data&&(void 0===t.data.SYSMSG._SerialNumber&&(t.data.SYSMSG._SerialNumber=0),void 0===t.data.SYSMSG._Sender&&(t.data.SYSMSG._Sender=0),void 0===t.data.SYSMSG._Recipient&&(t.data.SYSMSG._Recipient=void 0!==n?n.mainUCid:0)),t},t}]),mod.config(["$httpProvider",function(e){e.interceptors.push("$cxRequestInterceptor")}]);