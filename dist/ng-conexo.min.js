!function(e){e.module("ngConexo.config",[]).value("ngConexo.config",{debug:!0}),e.module("ngConexo.services",["LocalStorageModule"]),e.module("ngConexo",["ngConexo.config","ngConexo.services","ngSanitize"])}(angular);var mod=angular.module("ngConexo.services");mod.constant("$cxConstants",{LOGOUT:4,LOGIN:5,USER_DATA:7,OPEN_UC:11}),mod.factory("$cxAuth",["$cxRequest","$q","localStorageService","$cxConstants",function(e,t,n){var o={};return o.updateSession=function(e){n.set("context",e)},o.getAuth=function(){var t=e.getSessionContext();return void 0===t&&(t=n.get("context"),void 0!==t||null!==t?e.setSessionContext(angular.fromJson(t)):t=void 0),t},o.cleanAuth=function(){n.remove("context"),n.remove("user"),this.user={name:"",nature:"anonymous"}},o.isAuthenticated=function(){return void 0!==this.getAuth()||null!==this.getAuth()},o.isAuthorized=function(e){return angular.isArray(e)||(e=[e]),console.log("user role: "+this.user.nature+" authorized: "+e[0]),-1!==e.indexOf(this.user.nature)},o.login=function(o){var i=this,r=t.defer();return e.openSession(o).then(function(t){console.log(t),n.set("context",t),e.getUserData(o).then(function(e){i.user={},i.user.id=e.SYSMSG.ID[0]._,i.user.login=e.SYSMSG.Name[0]._,i.user.email=e.SYSMSG.Email[0]._,i.user.nature=void 0!==e.SYSMSG.Profile?e.SYSMSG.Profile[0]._:"unknown",n.set("user",i.user),r.resolve(i.user)},function(e){r.reject(e)})},function(e){r.reject(e)}),r.promise},o.logout=function(){var n=t.defer();return e.closeSession().then(function(){o.cleanAuth(),n.resolve(!0)},function(e){n.reject(e)}),n.promise},o.getUser=function(){return void 0===this.user&&(this.user=n.get("user"),this.user=void 0===this.user||null===this.user?{name:"",nature:"anonymous"}:angular.fromJson(this.user)),this.user},e.registerOnContextUpdate(o.updateSession),o.getAuth(),o.getUser(),o}]);var mod=angular.module("ngConexo.services");mod.provider("$cxRequest",[function(){var e="",t="localhost",n="",o="",i="",r=1e5,s={},c=function(){s={headers:{"Content-type":"application/json",cxSystemCode:n,cxServer:t,cxPort:o}}};this.setUrl=function(t){e=t},this.setServer=function(e){t=e,c()},this.setSysCode=function(e){n=e,c()},this.setPort=function(e){o=e,c()},this.setChannel=function(e){i=e},this.setTimeout=function(e){r=e},this.$get=function(t,o,c,u,S){var a={};return a.registerOnConnectionError=function(e){this.onConnectionError=e},a.registerOnTimeoutError=function(e){this.onTimeoutError=e},a.registerOnContextUpdate=function(e){this.onContextUpdate=e},a.getSessionContext=function(){return this.context},a.setSessionContext=function(e){this.context=e},a.initSessionContext=function(){var e={mainUCid:void 0,openUC:{}};return e},a.resetSessionContext=function(){this.context=void 0},a.updateContext=function(){void 0!==this.onContextUpdate&&this.onContextUpdate(this.getSessionContext())},a.getSessionContext=function(){return this.context},a.newRequest=function(e,t){var n={};return n.ucid=e,n.signal=t,n.data={SYSMSG:{_SignalName:void 0,_SerialNumber:void 0,_Recipient:void 0,_Sender:void 0}},n.send=function(){return a.callUseCase(this.ucid,this.signal,this.data)},n},a.execute=function(n){var i=this,c=o.defer();return console.log("execute:"),console.log(n),t.post(e,n,s).success(function(e){console.log(e),1===e.SYSMSG._Id?(e.SYSMSG.MESSAGE[0]._.indexOf("Destinario da requisição não encontrado")>-1&&(i.resetSessionContext(),i.onTimeoutError(e.SYSMSG.MESSAGE[0]._)),c.reject(e.SYSMSG.MESSAGE[0]._)):2===e.SYSMSG._Id?c.reject(e.SYSMSG.MESSAGE[0]._):c.resolve(e),void 0!==i.timer&&(console.log("canceling timeout"),S.cancel(i.timer)),console.log("reset timeout"),i.timer=S(function(){console.log("timeout reached"),i.resetSessionContext(),i.onTimeoutError("Tempo limite da sessão expirado")},r)}).error(function(e){void 0!==i.timer&&(console.log("canceling timeout2"),S.cancel(i.timer)),i.onConnectionError(e),c.reject(e)}),c.promise},a.getUserData=function(e){var t=this,r=o.defer(),s={SYSMSG:{_SignalName:u.USER_DATA,_Recipient:0,SYSTEM_CODE:n,LOGIN:e.username,AUDIT_CONTEXT:"",CLIENT_VERSION:"1.0.5.0",CHANNEL:i}};return t.execute(s).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.openSession=function(e){var t=this,r=o.defer(),s={SYSMSG:{_SignalName:u.LOGIN,_Recipient:0,SYSTEM_CODE:n,LOGIN:e.username,PASSWORD:e.password,AUDIT_CONTEXT:"",CLIENT_VERSION:"1.0.5.0",CHANNEL:i}};return console.log(s),t.execute(s).then(function(e){t.context=t.initSessionContext(),t.context.mainUCid=e.SYSMSG.UCID[0]._,r.resolve(t.context)},function(e){r.reject(e)}),r.promise},a.closeSession=function(){var e=this,t=o.defer(),n={SYSMSG:{_SignalName:u.LOGOUT}};return e.execute(n).then(function(){e.resetSessionContext(),t.resolve(!0)},function(e){t.reject(e)}),t.promise},a.openUseCase=function(e){var t={SYSMSG:{_Recipient:this.context.mainUCid,_SignalName:u.OPEN_UC,USECASEID:e,GUIID:e}};return this.execute(t)},a.callUseCase=function(e,t,n){var i=this,r=o.defer();return console.log(i.context),void 0!==i.context?(console.log(i.context.openUC),void 0===i.context.openUC[e]?i.openUseCase(e).then(function(o){console.log("uc opened"),console.log(o),i.context.openUC[e]=o.SYSMSG.UCID[0]._,i.updateContext(),n.SYSMSG._SignalName=t,n.SYSMSG._Recipient=i.context.openUC[e],i.execute(n).then(function(e){r.resolve(e)},function(e){r.reject(e)})},function(e){r.reject(e)}):(n.SYSMSG._SignalName=t,n.SYSMSG._Recipient=i.context.openUC[e],i.execute(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}))):r.reject("not authenticated"),r.promise},a}}]);var mod=angular.module("ngConexo.services");mod.factory("$cxRequestInterceptor",["$injector",function(e){var t={};return t.request=function(t){var n=e.get("$cxAuth").getAuth();return"POST"===t.method&&void 0!==t.data&&(void 0===t.data.SYSMSG._SerialNumber&&(t.data.SYSMSG._SerialNumber=0),void 0===t.data.SYSMSG._Sender&&(t.data.SYSMSG._Sender=0),void 0===t.data.SYSMSG._Recipient&&(t.data.SYSMSG._Recipient=void 0!==n?n.mainUCid:0)),t},t}]),mod.config(["$httpProvider",function(e){e.interceptors.push("$cxRequestInterceptor")}]),mod.config(["localStorageServiceProvider",function(e){e.setPrefix("auth"),e.setStorageType("localStorage"),e.setNotify(!0,!0)}]);