!function(e){e.module("ngConexo.config",[]).value("ngConexo.config",{debug:!0}),e.module("ngConexo.services",[]),e.module("ngConexo",["ngConexo.config","ngConexo.services","ngCookies","ngSanitize"])}(angular);var mod=angular.module("ngConexo.services");mod.constant("$cxConstants",{LOGOUT:4,LOGIN:5,OPEN_UC:11}),mod.factory("$cxAuth",["$cxRequest","$q","$cookies","$cookieStore","$cxConstants",function(e,n,t,o){var i={};return i.updateSession=function(e){o.put("context",e)},i.getAuth=function(){var n=e.getSessionContext();return void 0===n&&(n=t.context,void 0!==n&&e.setSessionContext(angular.fromJson(n))),n},i.cleanAuth=function(){o.remove("context"),o.remove("user"),this.user={name:"",nature:"anonymous"}},i.isAuthenticated=function(){return void 0!==this.getAuth()},i.isAuthorized=function(e){return angular.isArray(e)||(e=[e]),console.log("user role: "+this.user.nature+" authorized: "+e[0]),-1!==e.indexOf(this.user.nature)},i.login=function(t){var i=this,r=n.defer();return e.openSession(t).then(function(n){console.log(n),o.put("context",n);var t=e.newRequest(2759,"RM_OBTEM_DADOS_USUARIO");t.send().then(function(e){i.user={},i.user.id=e.SYSMSG.user[0].id[0]._,i.user.login=e.SYSMSG.user[0].login[0]._,i.user.nature=e.SYSMSG.user[0].nature[0]._,void 0!==e.SYSMSG.user[0].name&&(i.user.name=e.SYSMSG.user[0].name[0]._),o.put("user",i.user),r.resolve(i.user)},function(e){r.reject(e)})},function(e){r.reject(e)}),r.promise},i.logout=function(){var t=n.defer();return e.closeSession().then(function(){i.cleanAuth(),t.resolve(!0)},function(e){t.reject(e)}),t.promise},i.getUser=function(){return void 0===this.user&&(this.user=t.user,this.user=void 0===this.user?{name:"",nature:"anonymous"}:angular.fromJson(this.user)),this.user},e.registerOnContextUpdate(i.updateSession),i.getAuth(),i.getUser(),i}]);var mod=angular.module("ngConexo.services");mod.provider("$cxRequest",[function(){var e="",n="localhost",t="",o="",i="",r=1e4,s={},u=function(){s={headers:{"Content-type":"application/json",cxSystemCode:t,cxServer:n,cxPort:o}}};this.setUrl=function(n){e=n},this.setServer=function(e){n=e,u()},this.setSysCode=function(e){t=e,u()},this.setPort=function(e){o=e,u()},this.setChannel=function(e){i=e},this.setTimeout=function(e){r=e},this.$get=function(n,o,u,c,S){var a,d={};return d.registerOnConnectionError=function(e){this.onConnectionError=e},d.registerOnTimeoutError=function(e){this.onTimeoutError=e},d.registerOnContextUpdate=function(e){this.onContextUpdate=e},d.getSessionContext=function(){return this.context},d.setSessionContext=function(e){this.context=e},d.initSessionContext=function(){var e={mainUCid:void 0,openUC:{}};return e},d.resetSessionContext=function(){this.context=void 0},d.updateContext=function(){void 0!==this.onContextUpdate&&this.onContextUpdate(this.getSessionContext())},d.getSessionContext=function(){return this.context},d.newRequest=function(e,n){var t={};return t.ucid=e,t.signal=n,t.data={SYSMSG:{_SignalName:void 0,_SerialNumber:void 0,_Recipient:void 0,_Sender:void 0}},t.send=function(){return d.callUseCase(this.ucid,this.signal,this.data)},t},d.execute=function(t){var i=this,u=o.defer();return console.log("execute:"),console.log(t),n.post(e,t,s).success(function(e){console.log(e),1===e.SYSMSG._Id?(e.SYSMSG.MESSAGE[0]._.indexOf("Destinario da requisição não encontrado")>-1&&(i.resetSessionContext(),i.onTimeoutError(e.SYSMSG.MESSAGE[0]._)),u.reject(e.SYSMSG.MESSAGE[0]._)):2===e.SYSMSG._Id?u.reject(e.SYSMSG.MESSAGE[0]._):u.resolve(e),void 0!==i.timer&&(console.log("canceling timeout"),S.cancel(a)),console.log("reset timeout"),i.timer=S(function(){console.log("timeout reached"),i.resetSessionContext(),i.onTimeoutError("Tempo limite da sessão expirado")},r)}).error(function(e){void 0!==i.timer&&(console.log("canceling timeout2"),S.cancel(a)),i.onConnectionError(e),u.reject(e)}),u.promise},d.openSession=function(e){var n=this,r=o.defer(),s={SYSMSG:{_SignalName:c.LOGIN,_Recipient:0,SYSTEM_CODE:t,LOGIN:e.username,PASSWORD:e.password,AUDIT_CONTEXT:"",CLIENT_VERSION:"1.0.5.0",CHANNEL:i}};return console.log(s),n.execute(s).then(function(e){n.context=n.initSessionContext(),n.context.mainUCid=e.SYSMSG.UCID[0]._,r.resolve(n.context)},function(e){r.reject(e)}),r.promise},d.closeSession=function(){var e=this,n=o.defer(),t={SYSMSG:{_SignalName:c.LOGOUT}};return e.execute(t).then(function(){e.resetSessionContext(),n.resolve(!0)},function(e){n.reject(e)}),n.promise},d.openUseCase=function(e){var n={SYSMSG:{_Recipient:this.context.mainUCid,_SignalName:c.OPEN_UC,USECASEID:e,GUIID:e}};return this.execute(n)},d.callUseCase=function(e,n,t){var i=this,r=o.defer();return console.log(i.context),void 0!==i.context?(console.log(i.context.openUC),void 0===i.context.openUC[e]?i.openUseCase(e).then(function(o){console.log("uc opened"),console.log(o),i.context.openUC[e]=o.SYSMSG.UCID[0]._,i.updateContext(),t.SYSMSG._SignalName=n,t.SYSMSG._Recipient=i.context.openUC[e],i.execute(t).then(function(e){r.resolve(e)},function(e){r.reject(e)})},function(e){r.reject(e)}):(t.SYSMSG._SignalName=n,t.SYSMSG._Recipient=i.context.openUC[e],i.execute(t).then(function(e){r.resolve(e)},function(e){r.reject(e)}))):r.reject("not authenticated"),r.promise},d}}]);var mod=angular.module("ngConexo.services");mod.factory("$cxRequestInterceptor",["$injector",function(e){var n={};return n.request=function(n){var t=e.get("$cxAuth").getAuth();return"POST"===n.method&&void 0!==n.data&&(void 0===n.data.SYSMSG._SerialNumber&&(n.data.SYSMSG._SerialNumber=0),void 0===n.data.SYSMSG._Sender&&(n.data.SYSMSG._Sender=0),void 0===n.data.SYSMSG._Recipient&&(n.data.SYSMSG._Recipient=void 0!==t?t.mainUCid:0)),n},n}]),mod.config(["$httpProvider",function(e){e.interceptors.push("$cxRequestInterceptor")}]);